{% extends 'core/base.html' %}
{% load static form_tags %}

{% block extra_head %}
<style>
  /* Modern Autocomplete Combobox Styles */
  #class_autocomplete {
    transition: all 0.2s ease;
  }
  
  #class_autocomplete:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  #class_suggestions {
    animation: slideDown 0.2s ease;
  }
  
  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .suggestion-item {
    padding: 12px 16px;
    cursor: pointer;
    transition: background-color 0.15s ease;
    direction: rtl;
    text-align: right;
    border-bottom: 1px solid #f3f4f6;
  }
  
  .suggestion-item:last-child {
    border-bottom: none;
  }
  
  .suggestion-item:hover,
  .suggestion-item.selected {
    background-color: #eff6ff;
  }
  
  .suggestion-item.selected {
    background-color: #dbeafe;
    font-weight: 500;
  }
  
  .no-results {
    padding: 16px;
    text-align: center;
    color: #6b7280;
    font-size: 14px;
  }
  
  .loading {
    padding: 16px;
    text-align: center;
    color: #6b7280;
    font-size: 14px;
  }
</style>
{% endblock %}

{% block content %}
  <div class="bg-white p-6 rounded-xl shadow-md ring-1 ring-gray-200">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-2xl font-bold">ثبت دانش‌آموز جدید</h2>
        <p class="text-sm text-gray-500">فرم ثبت اطلاعات پایه دانش‌آموزان مرکز</p>
      </div>
      <div class="hidden sm:flex items-center gap-3">
        <a href="{% url 'core:student_list' %}" class="text-sm text-blue-600 hover:underline">بازگشت به لیست</a>
      </div>
    </div>

    <form id="student-wizard-form" method="post" enctype="multipart/form-data" class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
      {% csrf_token %}

      <!-- Left: image upload -->
      <div class="md:col-span-1 flex flex-col items-center">
        <label class="block text-sm font-medium text-gray-700 mb-3">عکس دانش‌آموز</label>

        <div class="w-44 h-44 bg-gray-50 rounded-lg flex items-center justify-center overflow-hidden border border-dashed border-gray-200">
          <img id="preview" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><rect fill='%23f3f4f6' width='200' height='200'/><g transform='translate(50,30)'><circle cx='50' cy='40' r='30' fill='%23e5e7eb'/><rect x='20' y='90' width='60' height='20' rx='10' fill='%23e5e7eb'/></g></svg>" alt="پیش‌نمایش" class="w-full h-full object-cover" />
        </div>

        <label for="id_image" class="mt-3 w-full inline-flex justify-center items-center px-3 py-2 bg-white border rounded-md text-sm text-gray-700 hover:bg-gray-50 cursor-pointer">
          انتخاب فایل
        </label>
        {{ form.image }}

        <p class="text-xs text-gray-400 mt-2">فرمت‌های مجاز: JPG, PNG — حداکثر 2MB</p>
      </div>

      <!-- Right: inputs -->
      <div class="md:col-span-2 space-y-4">
        <div class="rounded-xl border border-blue-100 bg-blue-50 p-3">
          <div class="flex items-center justify-between text-xs text-blue-700">
            <span id="student-step-counter">مرحله ۱ از ۴</span>
            <span id="student-step-title">مشخصات فردی</span>
          </div>
          <div class="mt-3 grid grid-cols-4 gap-2 text-xs sm:text-sm">
            <button type="button" data-student-step-indicator="1" class="student-step-indicator rounded-md px-2 py-2 font-medium transition-colors">۱. مشخصات</button>
            <button type="button" data-student-step-indicator="2" class="student-step-indicator rounded-md px-2 py-2 font-medium transition-colors">۲. آدرس</button>
            <button type="button" data-student-step-indicator="3" class="student-step-indicator rounded-md px-2 py-2 font-medium transition-colors">۳. آموزش</button>
            <button type="button" data-student-step-indicator="4" class="student-step-indicator rounded-md px-2 py-2 font-medium transition-colors">۴. تماس و صنف</button>
          </div>
        </div>

        <section class="student-step-panel space-y-4" data-student-step="1" data-step-title="مشخصات فردی">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">نام و نام خانوادگی</label>
              {{ form.name|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
              {% if form.name.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.name.errors|striptags }}</p>
              {% endif %}
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">نام پدر</label>
              {{ form.father_name|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
              {% if form.father_name.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.father_name.errors|striptags }}</p>
              {% endif %}
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">نام پدر کلان</label>
              {{ form.grandfather_name|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
              {% if form.grandfather_name.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.grandfather_name.errors|striptags }}</p>
              {% endif %}
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">جنسیت</label>
              {{ form.gender|add_class:'mt-1 block w-full rounded-md border-gray-300' }}
              {% if form.gender.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.gender.errors|striptags }}</p>
              {% endif %}
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">نمبر تذکره</label>
              {{ form.id_number|add_class:'mt-1 block w-full rounded-md border-gray-300' }}
              {% if form.id_number.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.id_number.errors|striptags }}</p>
              {% endif %}
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">تاریخ تولد</label>
              {{ form.birth_date|add_class:'mt-1 block w-full rounded-md border-gray-300' }}
              {% if form.birth_date.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.birth_date.errors|striptags }}</p>
              {% endif %}
            </div>
          </div>

        </section>

        <section class="student-step-panel space-y-4 hidden" data-student-step="2" data-step-title="آدرس">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="rounded-lg border border-gray-200 p-4">
              <p class="text-xl font-medium text-blue-400 mb-3">سکونت اصلی</p>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">ولایت اصلی</label>
                  {{ form.permanent_address|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500 h-10 resize-none' }}
                  {% if form.permanent_address.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.permanent_address.errors|striptags }}</p>
                  {% endif %}
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700">ولسوالی</label>
                  {{ form.district|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
                  {% if form.district.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.district.errors|striptags }}</p>
                  {% endif %}
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700">قریه</label>
                  {{ form.village|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
                  {% if form.village.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.village.errors|striptags }}</p>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="rounded-lg border border-gray-200 p-4">
              <p class="text-xl font-medium text-blue-400 mb-3">سکونت فعلی</p>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">ولایت فعلی</label>
                  {{ form.current_address|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500 h-10 resize-none' }}
                  {% if form.current_address.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.current_address.errors|striptags }}</p>
                  {% endif %}
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700">ناحیه</label>
                  {{ form.area|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
                  {% if form.area.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.area.errors|striptags }}</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="student-step-panel space-y-4 hidden" data-student-step="3" data-step-title="اطلاعات آموزشی">
          <div>
            <label class="block text-sm font-medium text-gray-700">تایم</label>
            <div class="mt-1 grid grid-cols-2 gap-2 items-center">
              <div>
                <label class="block text-xs text-gray-600">تایم آغاز</label>
                {{ form.time_start|add_class:'mt-1 block w-full rounded-md border-gray-300' }}
              </div>
              <div>
                <label class="block text-xs text-gray-600">تایم ختم</label>
                {{ form.time_end|add_class:'mt-1 block w-full rounded-md border-gray-300' }}
              </div>
            </div>

            <div id="exam-number-section" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">نمبر امتحان کانکور (فقط دوره عالی)</label>
                {{ form.exam_number|add_class:'mt-1 block w-full rounded-md border-gray-300' }}
              </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">سطح آموزشی</label>
                {{ form.level|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
                {% if form.level.errors %}
                  <p class="text-xs text-red-600 mt-1">{{ form.level.errors|striptags }}</p>
                {% endif %}
              </div>
              <div id="grade12-section" class="sm:col-span-2">
                <label class="block text-sm font-medium text-gray-700">فارغ صنف دوازدهم</label>
                <label class="inline-flex items-center gap-2 mt-2 text-sm text-gray-700">
                  {{ form.is_grade12_graduate }}
                  <span>فارغ صنف دوازدهم هست</span>
                </label>
                <p class="text-xs text-gray-500 mt-1">این گزینه فقط برای دوره عالی است.</p>
                {% if form.is_grade12_graduate.errors %}
                  <p class="text-xs text-red-600 mt-1">{{ form.is_grade12_graduate.errors|striptags }}</p>
                {% endif %}
              </div>
            </div>

            <div id="semesters-section" class="mt-4">
              <label class="block text-sm font-medium text-gray-700">سمسترها (برای دوره عالی)</label>
              <div class="mt-2 grid grid-cols-2 sm:grid-cols-4 gap-2">
                {% for checkbox in form.semesters %}
                  <label class="inline-flex items-center gap-2 px-3 py-2 border border-gray-200 rounded-md text-sm text-gray-700">
                    {{ checkbox.tag }}
                    <span>{{ checkbox.choice_label }}</span>
                  </label>
                {% endfor %}
              </div>
              {% if form.semesters.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.semesters.errors|striptags }}</p>
              {% endif %}
            </div>

            <div id="periods-ebtedai-section" class="mt-4">
              <label class="block text-sm font-medium text-gray-700">دوره‌های ابتداییه</label>
              <div class="mt-2">
                <input id="period_ebtedai_search_input" type="text" placeholder="جستجو دوره ابتداییه (۱ تا ۶)" class="block w-full rounded-md border-gray-300 border p-2" autocomplete="off">
                <div id="selected_periods_ebtedai" class="mt-2 flex flex-wrap gap-2"></div>
              </div>
              {% if form.periods.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.periods.errors|striptags }}</p>
              {% endif %}
            </div>

            <div id="periods-moteseta-section" class="mt-4">
              <label class="block text-sm font-medium text-gray-700">دوره‌های متوسطه</label>
              <div class="mt-2">
                <input id="period_moteseta_search_input" type="text" placeholder="جستجو دوره متوسطه (۱ تا ۶)" class="block w-full rounded-md border-gray-300 border p-2" autocomplete="off">
                <div id="selected_periods_moteseta" class="mt-2 flex flex-wrap gap-2"></div>
              </div>
              {% if form.periods.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.periods.errors|striptags }}</p>
              {% endif %}
            </div>
          </div>
        </section>

        <section class="student-step-panel space-y-4 hidden" data-student-step="4" data-step-title="تماس و صنف">
          <div>
            <label class="block text-sm font-medium text-gray-700 mt-4">صنف</label>
            <div class="relative mt-1">
              <input type="hidden" id="id_school_class" name="school_class" value="{% if form.instance.school_class %}{{ form.instance.school_class.id }}{% endif %}">

              <input
                type="text"
                id="class_autocomplete"
                autocomplete="off"
                placeholder="صنف را تایپ کنید..."
                value="{% if form.instance.school_class %}{{ form.instance.school_class.name }}{% endif %}"
                class="block w-full rounded-md border-gray-300 border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500 focus:ring-2 px-4 py-2.5 text-base"
                style="direction: rtl;">

              <div id="class_suggestions" class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg hidden max-h-60 overflow-auto">
              </div>
            </div>
            {% if form.school_class.errors %}
              <p class="text-xs text-red-600 mt-1">{{ form.school_class.errors|striptags }}</p>
            {% endif %}
          </div>

          <div class="sm:w-1/2">
            <label class="block text-sm font-medium text-gray-700 mt-4">شماره موبایل</label>
            {{ form.mobile_number|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
            {% if form.mobile_number.errors %}
              <p class="text-xs text-red-600 mt-1">{{ form.mobile_number.errors|striptags }}</p>
            {% endif %}
          </div>
        </section>

        <div class="pt-4 flex flex-wrap items-center justify-between gap-3 border-t border-gray-200">
          <a href="{% url 'core:student_list' %}" class="inline-flex items-center gap-2 border border-gray-300 px-4 py-2 rounded-md text-gray-700">انصراف</a>
          <div class="flex items-center gap-2">
            <button type="button" id="student-prev-step" class="hidden inline-flex items-center gap-2 border border-gray-300 px-4 py-2 rounded-md text-gray-700 hover:bg-gray-50">مرحله قبل</button>
            <button type="button" id="student-next-step" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md shadow">مرحله بعد</button>
            <button type="submit" id="student-submit-step" class="hidden inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md shadow">ثبت دانش‌آموز</button>
          </div>
        </div>
      </div>
    </form>
  </div>


{% block extra_js %}
  <link rel="stylesheet" href="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.css">
  <script src="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.js"></script>

  {% if period_names %}
    {{ period_names|json_script:"periodNames" }}
  {% else %}
    <script id="periodNames" type="application/json">[]</script>
  {% endif %}

  {% if student_periods_ebtedai %}
    {{ student_periods_ebtedai|json_script:"studentPeriodsEbtedai" }}
  {% else %}
    <script id="studentPeriodsEbtedai" type="application/json">[]</script>
  {% endif %}

  {% if student_periods_moteseta %}
    {{ student_periods_moteseta|json_script:"studentPeriodsMoteseta" }}
  {% else %}
    <script id="studentPeriodsMoteseta" type="application/json">[]</script>
  {% endif %}

<script>
  (function(){
    const afghanMonths = ['حمل','ثور','جوزا','سرطان','اسد','سنبله','میزان','عقرب','قوس','جدی','دلو','حوت'];
    if (window.jalaliDatepicker) {
      jalaliDatepicker.startWatch({
        time: false,
        months: afghanMonths,
      });
    }
  })();
</script>

<script>
  (function(){
    const fileInput = document.querySelector('#id_image');
    const preview = document.getElementById('preview');
    if (!fileInput) return;

    // hide default file input (it's already rendered by Django field)
    fileInput.classList.add('hidden');

    fileInput.addEventListener('change', function(e){
      const file = this.files && this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){ preview.src = ev.target.result; };
      reader.readAsDataURL(file);
    });
  })();
</script>

<script>
(function() {
  // Professional Autocomplete Combobox - Like Google, Amazon, etc.
  const input = document.getElementById('class_autocomplete');
  const hiddenInput = document.getElementById('id_school_class');
  const suggestionsContainer = document.getElementById('class_suggestions');
  
  let currentFocus = -1;
  let searchTimeout = null;
  let currentSuggestions = [];
  
  // Fetch suggestions from server
  async function fetchSuggestions(query) {
    if (!query || query.trim().length === 0) {
      hideSuggestions();
      return;
    }
    
    try {
      showLoading();
      
      const response = await fetch(`{% url 'core:api_class_search' %}?q=${encodeURIComponent(query)}`);
      const data = await response.json();
      
      currentSuggestions = data.results;
      displaySuggestions(data.results);
    } catch (error) {
      console.error('Error fetching suggestions:', error);
      showError();
    }
  }
  
  // Display suggestions in dropdown
  function displaySuggestions(suggestions) {
    suggestionsContainer.innerHTML = '';
    
    if (suggestions.length === 0) {
      suggestionsContainer.innerHTML = '<div class="no-results">هیچ صنفی یافت نشد</div>';
      suggestionsContainer.classList.remove('hidden');
      return;
    }
    
    suggestions.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'suggestion-item';
      div.textContent = item.text;
      div.dataset.id = item.id;
      div.dataset.text = item.text;
      div.dataset.index = index;
      
      // Mouse click
      div.addEventListener('click', () => selectSuggestion(item.id, item.text));
      
      // Mouse hover
      div.addEventListener('mouseenter', () => {
        removeActiveClass();
        div.classList.add('selected');
        currentFocus = index;
      });
      
      suggestionsContainer.appendChild(div);
    });
    
    suggestionsContainer.classList.remove('hidden');
  }
  
  // Show loading state
  function showLoading() {
    suggestionsContainer.innerHTML = '<div class="loading">در حال جستجو...</div>';
    suggestionsContainer.classList.remove('hidden');
  }
  
  // Show error state
  function showError() {
    suggestionsContainer.innerHTML = '<div class="no-results">خطا در بارگذاری</div>';
    suggestionsContainer.classList.remove('hidden');
  }
  
  // Hide suggestions
  function hideSuggestions() {
    suggestionsContainer.classList.add('hidden');
    currentFocus = -1;
  }
  
  // Select a suggestion
  function selectSuggestion(id, text) {
    input.value = text;
    hiddenInput.value = id;
    hideSuggestions();
    input.blur();
  }
  
  // Remove active class from all items
  function removeActiveClass() {
    const items = suggestionsContainer.querySelectorAll('.suggestion-item');
    items.forEach(item => item.classList.remove('selected'));
  }
  
  // Input event - trigger search
  input.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    
    const query = this.value.trim();
    
    // Clear hidden input if user clears the text
    if (query === '') {
      hiddenInput.value = '';
      hideSuggestions();
      return;
    }
    
    // Debounce: wait 300ms after user stops typing
    searchTimeout = setTimeout(() => {
      fetchSuggestions(query);
    }, 300);
  });
  
  // Keyboard navigation
  input.addEventListener('keydown', function(e) {
    const items = suggestionsContainer.querySelectorAll('.suggestion-item');
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      currentFocus++;
      if (currentFocus >= items.length) currentFocus = 0;
      addActiveClass(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      currentFocus--;
      if (currentFocus < 0) currentFocus = items.length - 1;
      addActiveClass(items);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (currentFocus > -1 && items[currentFocus]) {
        items[currentFocus].click();
      }
    } else if (e.key === 'Escape') {
      hideSuggestions();
    }
  });
  
  // Add active class to current item
  function addActiveClass(items) {
    removeActiveClass();
    if (currentFocus >= items.length) currentFocus = 0;
    if (currentFocus < 0) currentFocus = items.length - 1;
    items[currentFocus].classList.add('selected');
    items[currentFocus].scrollIntoView({ block: 'nearest' });
  }
  
  // Close suggestions when clicking outside
  document.addEventListener('click', function(e) {
    if (e.target !== input && e.target !== suggestionsContainer) {
      hideSuggestions();
    }
  });
  
  // Focus event - show suggestions if there's text
  input.addEventListener('focus', function() {
    if (this.value.trim().length > 0) {
      fetchSuggestions(this.value.trim());
    }
  });
})();
</script>

<script>
  (function(){
    function setupTagInput(searchInputId, selectedContainerId, listScriptId, hiddenInputName, preselected){
      const raw = document.getElementById(listScriptId) && document.getElementById(listScriptId).textContent;
      let items = [];
      try { items = raw ? JSON.parse(raw) : []; } catch(e){ items = []; }

      const input = document.getElementById(searchInputId);
      const container = document.getElementById(selectedContainerId);
      if (!input || !container) return;

      const suggestions = document.createElement('ul');
      suggestions.className = 'absolute z-50 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-md shadow max-h-60 overflow-auto hidden';
      suggestions.style.listStyle = 'none'; suggestions.style.padding = '0'; suggestions.style.margin = '0';
      input.parentNode.style.position = 'relative';
      input.parentNode.appendChild(suggestions);

      function renderList(matches){
        suggestions.innerHTML = '';
        if (!matches.length){ suggestions.classList.add('hidden'); return; }
        matches.slice(0,20).forEach(item => {
          const li = document.createElement('li'); li.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm';
          const label = (typeof item === 'object' && item.label) ? item.label : item;
          li.textContent = label;
          li.addEventListener('click', function(){ addTag(item); suggestions.classList.add('hidden'); input.value = ''; });
          suggestions.appendChild(li);
        });
        suggestions.classList.remove('hidden');
      }

      function addTag(item){
        const value = (typeof item === 'object' && item.value) ? item.value : item;
        const label = (typeof item === 'object' && item.label) ? item.label : item;
        if (Array.from(container.querySelectorAll('input[type=hidden]')).some(i=>i.value===String(value))) return;
        const tag = document.createElement('span'); tag.className='inline-flex items-center gap-2 bg-gray-100 px-3 py-1 rounded-full text-sm'; tag.textContent=label;
        const removeBtn = document.createElement('button'); removeBtn.type='button'; removeBtn.className='ml-2 text-xs text-red-600'; removeBtn.textContent='×';
        const hidden = document.createElement('input'); hidden.type='hidden'; hidden.name = hiddenInputName; hidden.value = String(value);
        removeBtn.addEventListener('click', function(){ tag.remove(); hidden.remove(); });
        tag.appendChild(removeBtn); container.appendChild(tag); container.appendChild(hidden);
      }

      input.addEventListener('input', function(){
        const q = this.value.trim().toLowerCase(); if (!q){ suggestions.classList.add('hidden'); return; }
        const matches = items.filter(n => { const label = (typeof n==='object' && n.label)? n.label : n; return String(label).toLowerCase().includes(q); });
        renderList(matches);
      });

      document.addEventListener('click', function(e){ if (!input.parentNode.contains(e.target)) suggestions.classList.add('hidden'); });

      // prepopulate
      try{ const pre = preselected || []; pre.forEach(v => {
        const found = items.find(i => (typeof i==='object'? String(i.value)===String(v) : String(i)===String(v)));
        if (found) addTag(found); else addTag(v);
      }); }catch(e){}
    }

    const periodNamesRaw = document.getElementById('periodNames') && document.getElementById('periodNames').textContent;
    const studentPeriodsEbtedaiRaw = document.getElementById('studentPeriodsEbtedai') && document.getElementById('studentPeriodsEbtedai').textContent;
    const studentPeriodsMotesetaRaw = document.getElementById('studentPeriodsMoteseta') && document.getElementById('studentPeriodsMoteseta').textContent;

    let periodNames = [], studentPeriodsEbtedai = [], studentPeriodsMoteseta = [];
    try{ periodNames = periodNamesRaw? JSON.parse(periodNamesRaw): []; }catch(e){ periodNames = []; }
    try{ studentPeriodsEbtedai = studentPeriodsEbtedaiRaw? JSON.parse(studentPeriodsEbtedaiRaw): []; }catch(e){ studentPeriodsEbtedai = []; }
    try{ studentPeriodsMoteseta = studentPeriodsMotesetaRaw? JSON.parse(studentPeriodsMotesetaRaw): []; }catch(e){ studentPeriodsMoteseta = []; }

    setupTagInput('period_ebtedai_search_input','selected_periods_ebtedai','periodNames','periods', studentPeriodsEbtedai);
    setupTagInput('period_moteseta_search_input','selected_periods_moteseta','periodNames','periods', studentPeriodsMoteseta);
  })();
</script>

<script>
  (function() {
    const levelSelect = document.getElementById('id_level');
    const semestersSection = document.getElementById('semesters-section');
    const periodsEbtedaiSection = document.getElementById('periods-ebtedai-section');
    const periodsMotesetaSection = document.getElementById('periods-moteseta-section');
    const grade12Section = document.getElementById('grade12-section');
    const examNumberSection = document.getElementById('exam-number-section');
    const examNumberInput = document.getElementById('id_exam_number');

    const levelIds = {
      aali: '{{ level_ids.aali|default:"" }}',
      moteseta: '{{ level_ids.moteseta|default:"" }}',
      ebtedai: '{{ level_ids.ebtedai|default:"" }}',
    };

    function clearCheckboxes(section) {
      if (!section) return;
      section.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
      });
    }

    function clearTags(container) {
      if (!container) return;
      container.innerHTML = '';
    }

    function updateSections() {
      if (!levelSelect) return;
      const value = levelSelect.value;
      if (!value) {
        if (semestersSection) semestersSection.style.display = 'none';
        if (periodsEbtedaiSection) periodsEbtedaiSection.style.display = 'none';
        if (periodsMotesetaSection) periodsMotesetaSection.style.display = 'none';
        if (grade12Section) grade12Section.style.display = 'none';
        if (examNumberSection) examNumberSection.style.display = 'none';
        return;
      }

      const isAali = levelIds.aali && String(value) === String(levelIds.aali);
      const isEbtedai = levelIds.ebtedai && String(value) === String(levelIds.ebtedai);
      const isMoteseta = levelIds.moteseta && String(value) === String(levelIds.moteseta);

      if (semestersSection) semestersSection.style.display = isAali ? 'block' : 'none';
      if (periodsEbtedaiSection) periodsEbtedaiSection.style.display = isEbtedai ? 'block' : 'none';
      if (periodsMotesetaSection) periodsMotesetaSection.style.display = isMoteseta ? 'block' : 'none';
      if (grade12Section) grade12Section.style.display = isAali ? 'block' : 'none';
      if (examNumberSection) examNumberSection.style.display = isAali ? 'block' : 'none';

      if (isAali) {
        clearTags(document.getElementById('selected_periods_ebtedai'));
        clearTags(document.getElementById('selected_periods_moteseta'));
      } else if (isEbtedai) {
        clearCheckboxes(semestersSection);
        clearTags(document.getElementById('selected_periods_moteseta'));
        const grad = document.getElementById('id_is_grade12_graduate');
        if (grad) grad.checked = false;
        if (examNumberInput) examNumberInput.value = '';
      } else if (isMoteseta) {
        clearCheckboxes(semestersSection);
        clearTags(document.getElementById('selected_periods_ebtedai'));
        const grad = document.getElementById('id_is_grade12_graduate');
        if (grad) grad.checked = false;
        if (examNumberInput) examNumberInput.value = '';
      }
    }

    if (levelSelect) {
      levelSelect.addEventListener('change', updateSections);
      updateSections();
    }
  })();
</script>

<script>
  (function() {
    const form = document.getElementById('student-wizard-form');
    if (!form) return;

    const stepPanels = Array.from(form.querySelectorAll('.student-step-panel'));
    const stepIndicators = Array.from(form.querySelectorAll('.student-step-indicator'));
    const prevButton = document.getElementById('student-prev-step');
    const nextButton = document.getElementById('student-next-step');
    const submitButton = document.getElementById('student-submit-step');
    const stepCounter = document.getElementById('student-step-counter');
    const stepTitle = document.getElementById('student-step-title');
    const totalSteps = stepPanels.length;

    let currentStep = 1;

    function getPanel(step) {
      return stepPanels.find((panel) => Number(panel.dataset.studentStep) === Number(step));
    }

    function setIndicatorStyles(activeStep) {
      stepIndicators.forEach((indicator) => {
        const isActive = Number(indicator.dataset.studentStepIndicator) === Number(activeStep);
        if (isActive) {
          indicator.classList.remove('bg-white', 'text-gray-600');
          indicator.classList.add('bg-blue-600', 'text-white');
          indicator.setAttribute('aria-current', 'step');
        } else {
          indicator.classList.remove('bg-blue-600', 'text-white');
          indicator.classList.add('bg-white', 'text-gray-600');
          indicator.removeAttribute('aria-current');
        }
      });
    }

    function setStep(step) {
      const safeStep = Math.min(Math.max(Number(step), 1), totalSteps);
      currentStep = safeStep;

      stepPanels.forEach((panel) => {
        panel.classList.toggle('hidden', Number(panel.dataset.studentStep) !== safeStep);
      });

      if (stepCounter) {
        stepCounter.textContent = `مرحله ${safeStep} از ${totalSteps}`;
      }

      const activePanel = getPanel(safeStep);
      if (stepTitle && activePanel) {
        stepTitle.textContent = activePanel.dataset.stepTitle || '';
      }

      if (prevButton) {
        prevButton.classList.toggle('hidden', safeStep === 1);
      }
      if (nextButton) {
        nextButton.classList.toggle('hidden', safeStep === totalSteps);
      }
      if (submitButton) {
        submitButton.classList.toggle('hidden', safeStep !== totalSteps);
      }

      setIndicatorStyles(safeStep);
    }

    function requireValue(selector, message, focusSelector, stepOverride) {
      const el = form.querySelector(selector);
      if (!el) return true;
      const value = (el.value || '').trim();
      if (!value) {
        setStep(stepOverride || currentStep);
        alert(message);
        const focusEl = focusSelector ? form.querySelector(focusSelector) : el;
        if (focusEl && focusEl.focus) focusEl.focus();
        return false;
      }
      return true;
    }

    function requireChecked(selector, message, stepOverride) {
      const el = form.querySelector(selector);
      if (!el) return true;
      if (!el.checked) {
        setStep(stepOverride || currentStep);
        alert(message);
        if (el.focus) el.focus();
        return false;
      }
      return true;
    }

    function requireAnyChecked(containerSelector, message, stepOverride) {
      const container = form.querySelector(containerSelector);
      if (!container) return true;
      const checked = container.querySelectorAll('input[type="checkbox"]:checked');
      if (!checked.length) {
        setStep(stepOverride || currentStep);
        alert(message);
        return false;
      }
      return true;
    }

    function requireAnyHidden(containerSelector, message, stepOverride) {
      const container = form.querySelector(containerSelector);
      if (!container) return true;
      const hiddenInputs = container.querySelectorAll('input[type="hidden"]');
      if (!hiddenInputs.length) {
        setStep(stepOverride || currentStep);
        alert(message);
        return false;
      }
      return true;
    }

    function validateStep(step) {
      const panel = getPanel(step);
      if (!panel) return true;

      const levelIds = {
        aali: '{{ level_ids.aali|default:"" }}',
        moteseta: '{{ level_ids.moteseta|default:"" }}',
        ebtedai: '{{ level_ids.ebtedai|default:"" }}',
      };

      if (step === 1) {
        if (!requireValue('#id_name', 'نام و نام خانوادگی را وارد کنید.', null, step)) return false;
        if (!requireValue('#id_father_name', 'نام پدر را وارد کنید.', null, step)) return false;
        if (!requireValue('#id_grandfather_name', 'نام پدر کلان را وارد کنید.', null, step)) return false;
        if (!requireValue('#id_gender', 'جنسیت را انتخاب کنید.', null, step)) return false;
        if (!requireValue('#id_id_number', 'نمبر تذکره را وارد کنید.', null, step)) return false;
        if (!requireValue('#id_birth_date', 'تاریخ تولد را وارد کنید.', null, step)) return false;
      }

      if (step === 2) {
        if (!requireValue('#id_permanent_address', 'ولایت اصلی را وارد کنید.', null, step)) return false;
        if (!requireValue('#id_district', 'ولسوالی را وارد کنید.', null, step)) return false;
        if (!requireValue('#id_village', 'قریه را وارد کنید.', null, step)) return false;
        if (!requireValue('#id_current_address', 'ولایت فعلی را وارد کنید.', null, step)) return false;
        if (!requireValue('#id_area', 'ناحیه را وارد کنید.', null, step)) return false;
      }

      if (step === 3) {
        if (!requireValue('#id_time_start', 'تایم آغاز را وارد کنید.', null, step)) return false;
        if (!requireValue('#id_time_end', 'تایم ختم را وارد کنید.', null, step)) return false;
        if (!requireValue('#id_level', 'سطح آموزشی را انتخاب کنید.', null, step)) return false;

        const levelValue = (form.querySelector('#id_level') && form.querySelector('#id_level').value) || '';
        const isAali = levelIds.aali && String(levelValue) === String(levelIds.aali);
        const isEbtedai = levelIds.ebtedai && String(levelValue) === String(levelIds.ebtedai);
        const isMoteseta = levelIds.moteseta && String(levelValue) === String(levelIds.moteseta);

        if (isAali) {
          if (!requireValue('#id_exam_number', 'نمبر امتحان کانکور را وارد کنید.', null, step)) return false;
        }

        if (isAali) {
          if (!requireChecked('#id_is_grade12_graduate', 'برای دوره عالی، گزینه فارغ صنف دوازدهم الزامی است.', step)) return false;
          if (!requireAnyChecked('#semesters-section', 'حداقل یک سمستر را انتخاب کنید.', step)) return false;
        } else if (isEbtedai) {
          if (!requireAnyHidden('#selected_periods_ebtedai', 'حداقل یک دوره ابتداییه را انتخاب کنید.', step)) return false;
        } else if (isMoteseta) {
          if (!requireAnyHidden('#selected_periods_moteseta', 'حداقل یک دوره متوسطه را انتخاب کنید.', step)) return false;
        }
      }

      if (step === 4) {
        if (!requireValue('#id_school_class', 'صنف را انتخاب کنید.', '#class_autocomplete', step)) return false;
        if (!requireValue('#id_mobile_number', 'شماره موبایل را وارد کنید.', null, step)) return false;
      }

      return true;
    }

    if (prevButton) {
      prevButton.addEventListener('click', function() {
        setStep(currentStep - 1);
      });
    }

    if (nextButton) {
      nextButton.addEventListener('click', function() {
        if (!validateStep(currentStep)) return;
        setStep(currentStep + 1);
      });
    }

    stepIndicators.forEach((indicator) => {
      indicator.addEventListener('click', function() {
        const targetStep = Number(indicator.dataset.studentStepIndicator);
        if (!targetStep || targetStep === currentStep) return;

        if (targetStep > currentStep && !validateStep(currentStep)) {
          return;
        }

        setStep(targetStep);
      });
    });

    form.addEventListener('submit', function(event) {
      for (let step = 1; step <= totalSteps; step += 1) {
        if (!validateStep(step)) {
          event.preventDefault();
          return;
        }
      }
    });

    const firstError = form.querySelector('p.text-red-600');
    if (firstError) {
      const errorPanel = firstError.closest('.student-step-panel');
      if (errorPanel && errorPanel.dataset.studentStep) {
        currentStep = Number(errorPanel.dataset.studentStep);
      }
    }

    setStep(currentStep);
  })();
</script>
{% endblock %}

{% endblock %}
