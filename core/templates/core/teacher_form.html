{% extends 'core/base.html' %}
{% load static form_tags %}

{% block content %}
  <div class="bg-white p-6 rounded-xl shadow-md ring-1 ring-gray-200">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-2xl font-bold">ثبت استاد جدید</h2>
        <p class="text-sm text-gray-500">فرم ثبت اطلاعات اساتید مرکز</p>
      </div>
      <div class="hidden sm:flex items-center gap-3">
        <a href="{% url 'core:teacher_list' %}" class="text-sm text-blue-600 hover:underline">بازگشت به لیست</a>
      </div>
    </div>

    <form id="teacher-wizard-form" method="post" enctype="multipart/form-data" class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
      {% csrf_token %}

      <!-- Left: image upload -->
      <div class="md:col-span-1 flex flex-col items-center">
        <label class="block text-sm font-medium text-gray-700 mb-3">عکس استاد</label>

        <div class="w-44 h-44 bg-gray-50 rounded-lg flex items-center justify-center overflow-hidden border border-dashed border-gray-200">
          <img id="preview" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><rect fill='%23f3f4f6' width='200' height='200'/><g transform='translate(50,30)'><circle cx='50' cy='40' r='30' fill='%23e5e7eb'/><rect x='20' y='90' width='60' height='20' rx='10' fill='%23e5e7eb'/></g></svg>" alt="پیش‌نمایش" class="w-full h-full object-cover" />
        </div>

        <label for="id_image" class="mt-3 w-full inline-flex justify-center items-center px-3 py-2 bg-white border rounded-md text-sm text-gray-700 hover:bg-gray-50 cursor-pointer">
          انتخاب فایل
        </label>
        {{ form.image }}

        <p class="text-xs text-gray-400 mt-2">فرمت‌های مجاز: JPG, PNG — حداکثر 2MB</p>
      </div>

      <!-- Right: inputs -->
      <div class="md:col-span-2 space-y-4">
        <div class="rounded-xl border border-blue-100 bg-blue-50 p-3">
          <div class="flex items-center justify-between text-xs text-blue-700">
            <span id="teacher-step-counter">مرحله ۱ از ۴</span>
            <span id="teacher-step-title">مشخصات شخصی</span>
          </div>
          <div class="mt-3 grid grid-cols-4 gap-2 text-xs sm:text-sm">
            <button type="button" data-teacher-step-indicator="1" class="teacher-step-indicator rounded-md px-2 py-2 font-medium transition-colors">۱. مشخصات</button>
            <button type="button" data-teacher-step-indicator="2" class="teacher-step-indicator rounded-md px-2 py-2 font-medium transition-colors">۲. آدرس</button>
            <button type="button" data-teacher-step-indicator="3" class="teacher-step-indicator rounded-md px-2 py-2 font-medium transition-colors">۳. اسناد</button>
            <button type="button" data-teacher-step-indicator="4" class="teacher-step-indicator rounded-md px-2 py-2 font-medium transition-colors">۴. تدریس</button>
          </div>
        </div>

        <section class="teacher-step-panel space-y-4" data-teacher-step="1" data-step-title="مشخصات شخصی">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">نام و تخلص استاد</label>
              {{ form.name|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
              {% if form.name.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.name.errors|striptags }}</p>
              {% endif %}
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">نام پدر</label>
              {{ form.father_name|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
              {% if form.father_name.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.father_name.errors|striptags }}</p>
              {% endif %}
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">جنسیت</label>
              {{ form.gender|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm' }}
              {% if form.gender.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.gender.errors|striptags }}</p>
              {% endif %}
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">نمبر تذکره</label>
              {{ form.id_number|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm' }}
              {% if form.id_number.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.id_number.errors|striptags }}</p>
              {% endif %}
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">تاریخ تولد</label>
              {{ form.birth_date|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm' }}
              {% if form.birth_date.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.birth_date.errors|striptags }}</p>
              {% endif %}
            </div>
          </div>

        </section>

        <section class="teacher-step-panel space-y-4 hidden" data-teacher-step="2" data-step-title="آدرس">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="rounded-lg border border-gray-200 p-4">
              <p class="text-xl font-medium text-blue-400 mb-3">سکونت اصلی</p>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">ولایت اصلی</label>
                  {{ form.permanent_address|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500 h-10 resize-none' }}
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700">ولسوالی</label>
                  {{ form.district|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
                  {% if form.district.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.district.errors|striptags }}</p>
                  {% endif %}
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700">قریه</label>
                  {{ form.village|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
                  {% if form.village.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.village.errors|striptags }}</p>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="rounded-lg border border-gray-200 p-4">
              <p class="text-xl font-medium text-blue-400 mb-3">سکونت فعلی</p>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700">ولایت فعلی</label>
                  {{ form.current_address|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500 h-10 resize-none' }}
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700">ناحیه</label>
                  {{ form.area|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
                  {% if form.area.errors %}
                    <p class="text-xs text-red-600 mt-1">{{ form.area.errors|striptags }}</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="teacher-step-panel space-y-4 hidden" data-teacher-step="3" data-step-title="اسناد تحصیلی/تجربه کاری">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">سویه تحصیلی</label>
              {{ form.education_level|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm' }}
              {% if form.education_level.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.education_level.errors|striptags }}</p>
              {% endif %}
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">اسناد تحصیلی (اجباری)</label>
              {% if form.instance.education_document %}
                {{ form.education_document|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm text-sm'|attr:'data-has-file=1' }}
              {% else %}
                {{ form.education_document|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm text-sm' }}
              {% endif %}
              {% if form.education_document.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.education_document.errors|striptags }}</p>
              {% endif %}
              <p class="text-xs text-gray-400 mt-1">فرمت‌های مجاز: PDF یا تصویر</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">اسناد تجربه کاری (اختیاری)</label>
              {{ form.experience_document|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm text-sm' }}
              {% if form.experience_document.errors %}
                <p class="text-xs text-red-600 mt-1">{{ form.experience_document.errors|striptags }}</p>
              {% endif %}
              <p class="text-xs text-gray-400 mt-1">در صورت موجود بودن، آپلود کنید</p>
            </div>
          </div>
        </section>

        <section class="teacher-step-panel space-y-4 hidden" data-teacher-step="4" data-step-title="تنظیمات تدریس">
          <div>
            <label class="block text-sm font-medium text-gray-700">سطوح تدریس (انتخاب یک یا چند مورد)</label>
            <div class="mt-1">
              <input id="level_search_input" type="text" placeholder="جستجو سطح (عالی، متوسطه، ابتداییه)" class="block w-full rounded-md border-gray-300 border p-2" autocomplete="off">
              <div id="selected_levels" class="mt-2 flex flex-wrap gap-2"></div>
              <p class="text-xs text-gray-400 mt-1">سمسترها مخصوص دوره عالی است و دوره‌ها مخصوص ابتداییه/متوسطه.</p>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">صنوف (جستجو و انتخاب)</label>
            <div class="mt-1">
              <input id="class_search_input" type="text" placeholder="جستجو صنف" class="block w-full rounded-md border-gray-300 border p-2" autocomplete="off">
              <div id="selected_classes" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">مضامین (جستجو و انتخاب)</label>
            <div class="mt-1">
              <input id="subject_search_input" type="text" placeholder="جستجو مضمون" class="block w-full rounded-md border-gray-300 border p-2" autocomplete="off">
              <div id="selected_subjects" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">سمسترها (برای دوره عالی)</label>
            <div class="mt-1">
              <input id="semester_search_input" type="text" placeholder="جستجو سمستر (۱ ۲ ۳ ۴)" class="block w-full rounded-md border-gray-300 border p-2" autocomplete="off">
              <div id="selected_semesters" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">دوره‌های ابتداییه</label>
            <div class="mt-1">
              <input id="period_ebtedai_search_input" type="text" placeholder="جستجو دوره ابتداییه (۱ تا ۶)" class="block w-full rounded-md border-gray-300 border p-2" autocomplete="off">
              <div id="selected_periods_ebtedai" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">دوره‌های متوسطه</label>
            <div class="mt-1">
              <input id="period_moteseta_search_input" type="text" placeholder="جستجو دوره متوسطه (۱ تا ۶)" class="block w-full rounded-md border-gray-300 border p-2" autocomplete="off">
              <div id="selected_periods_moteseta" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
          </div>
        </section>

        <div class="pt-4 flex flex-wrap items-center justify-between gap-3 border-t border-gray-200">
          <a href="{% url 'core:teacher_list' %}" class="inline-flex items-center gap-2 border border-gray-300 px-4 py-2 rounded-md text-gray-700">انصراف</a>
          <div class="flex items-center gap-2">
            <button type="button" id="teacher-prev-step" class="hidden inline-flex items-center gap-2 border border-gray-300 px-4 py-2 rounded-md text-gray-700 hover:bg-gray-50">مرحله قبل</button>
            <button type="button" id="teacher-next-step" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md shadow">مرحله بعد</button>
            <button type="submit" id="teacher-submit-step" class="hidden inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md shadow">ثبت استاد</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  {# Embed class and subject names and semester options as JSON for client-side search #}
  {% if class_names %}
    {{ class_names|json_script:"classNames" }}
  {% else %}
    <script id="classNames" type="application/json">[]</script>
  {% endif %}

  {% if subject_names %}
    {{ subject_names|json_script:"subjectNames" }}
  {% else %}
    <script id="subjectNames" type="application/json">[]</script>
  {% endif %}

  {% if level_names %}
    {{ level_names|json_script:"levelNames" }}
  {% else %}
    <script id="levelNames" type="application/json">[]</script>
  {% endif %}

  {% if semester_names %}
    {{ semester_names|json_script:"semesterNames" }}
  {% else %}
    <script id="semesterNames" type="application/json">[]</script>
  {% endif %}

  {% if period_names %}
    {{ period_names|json_script:"periodNames" }}
  {% else %}
    <script id="periodNames" type="application/json">[]</script>
  {% endif %}

  {% if teacher_classes %}
    {{ teacher_classes|json_script:"teacherClasses" }}
  {% else %}
    <script id="teacherClasses" type="application/json">[]</script>
  {% endif %}

  {% if teacher_subjects %}
    {{ teacher_subjects|json_script:"teacherSubjects" }}
  {% else %}
    <script id="teacherSubjects" type="application/json">[]</script>
  {% endif %}

  {% if teacher_levels %}
    {{ teacher_levels|json_script:"teacherLevels" }}
  {% else %}
    <script id="teacherLevels" type="application/json">[]</script>
  {% endif %}

  {% if teacher_semesters %}
    {{ teacher_semesters|json_script:"teacherSemesters" }}
  {% else %}
    <script id="teacherSemesters" type="application/json">[]</script>
  {% endif %}

  {% if teacher_periods_ebtedai %}
    {{ teacher_periods_ebtedai|json_script:"teacherPeriodsEbtedai" }}
  {% else %}
    <script id="teacherPeriodsEbtedai" type="application/json">[]</script>
  {% endif %}

  {% if teacher_periods_moteseta %}
    {{ teacher_periods_moteseta|json_script:"teacherPeriodsMoteseta" }}
  {% else %}
    <script id="teacherPeriodsMoteseta" type="application/json">[]</script>
  {% endif %}

{% block extra_js %}
<link rel="stylesheet" href="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.css">
<script src="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.js"></script>

<script>
  (function(){
    const afghanMonths = ['حمل','ثور','جوزا','سرطان','اسد','سنبله','میزان','عقرب','قوس','جدی','دلو','حوت'];
    if (window.jalaliDatepicker) {
      jalaliDatepicker.startWatch({
        time: false,
        months: afghanMonths,
      });
    }
  })();
</script>

<script>
  (function(){
    // image preview (same as student form)
    const fileInput = document.querySelector('#id_image');
    const preview = document.getElementById('preview');
    if (fileInput && preview) {
      fileInput.classList.add('hidden');
      fileInput.addEventListener('change', function(){
        const file = this.files && this.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(ev){ preview.src = ev.target.result; };
        reader.readAsDataURL(file);
      });
    }

    // simple tag selector used for classes, subjects, levels, semesters and periods
    function setupTagInput(searchInputId, selectedContainerId, listScriptId, hiddenInputName, preselected){
      const raw = document.getElementById(listScriptId) && document.getElementById(listScriptId).textContent;
      let items = [];
      try { items = raw ? JSON.parse(raw) : []; } catch(e){ items = []; }

      const input = document.getElementById(searchInputId);
      const container = document.getElementById(selectedContainerId);
      if (!input || !container) return;

      const suggestions = document.createElement('ul');
      suggestions.className = 'absolute z-50 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-md shadow max-h-60 overflow-auto hidden';
      suggestions.style.listStyle = 'none'; suggestions.style.padding = '0'; suggestions.style.margin = '0';
      input.parentNode.style.position = 'relative';
      input.parentNode.appendChild(suggestions);

      function renderList(matches){
        suggestions.innerHTML = '';
        if (!matches.length){ suggestions.classList.add('hidden'); return; }
        matches.slice(0,20).forEach(item => {
          const li = document.createElement('li'); li.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm';
          const label = (typeof item === 'object' && item.label) ? item.label : item;
          li.textContent = label;
          li.addEventListener('click', function(){ addTag(item); suggestions.classList.add('hidden'); input.value = ''; });
          suggestions.appendChild(li);
        });
        suggestions.classList.remove('hidden');
      }

      function addTag(item){
        const value = (typeof item === 'object' && item.value) ? item.value : item;
        const label = (typeof item === 'object' && item.label) ? item.label : item;
        if (Array.from(container.querySelectorAll('input[type=hidden]')).some(i=>i.value===String(value))) return;
        const tag = document.createElement('span'); tag.className='inline-flex items-center gap-2 bg-gray-100 px-3 py-1 rounded-full text-sm'; tag.textContent=label;
        const removeBtn = document.createElement('button'); removeBtn.type='button'; removeBtn.className='ml-2 text-xs text-red-600'; removeBtn.textContent='×';
        const hidden = document.createElement('input'); hidden.type='hidden'; hidden.name = hiddenInputName; hidden.value = String(value);
        removeBtn.addEventListener('click', function(){ tag.remove(); hidden.remove(); });
        tag.appendChild(removeBtn); container.appendChild(tag); container.appendChild(hidden);
      }

      input.addEventListener('input', function(){
        const q = this.value.trim().toLowerCase(); if (!q){ suggestions.classList.add('hidden'); return; }
        const matches = items.filter(n => { const label = (typeof n==='object' && n.label)? n.label : n; return String(label).toLowerCase().includes(q); });
        renderList(matches);
      });

      document.addEventListener('click', function(e){ if (!input.parentNode.contains(e.target)) suggestions.classList.add('hidden'); });

      // prepopulate
      try{ const pre = preselected || []; pre.forEach(v => {
        const found = items.find(i => (typeof i==='object'? String(i.value)===String(v) : String(i)===String(v)));
        if (found) addTag(found); else addTag(v);
      }); }catch(e){}
    }

    const classNamesRaw = document.getElementById('classNames') && document.getElementById('classNames').textContent;
    const subjectNamesRaw = document.getElementById('subjectNames') && document.getElementById('subjectNames').textContent;
    const levelNamesRaw = document.getElementById('levelNames') && document.getElementById('levelNames').textContent;
    const semesterNamesRaw = document.getElementById('semesterNames') && document.getElementById('semesterNames').textContent;
    const periodNamesRaw = document.getElementById('periodNames') && document.getElementById('periodNames').textContent;
    const teacherClassesRaw = document.getElementById('teacherClasses') && document.getElementById('teacherClasses').textContent;
    const teacherSubjectsRaw = document.getElementById('teacherSubjects') && document.getElementById('teacherSubjects').textContent;
    const teacherLevelsRaw = document.getElementById('teacherLevels') && document.getElementById('teacherLevels').textContent;
    const teacherSemestersRaw = document.getElementById('teacherSemesters') && document.getElementById('teacherSemesters').textContent;
    const teacherPeriodsEbtedaiRaw = document.getElementById('teacherPeriodsEbtedai') && document.getElementById('teacherPeriodsEbtedai').textContent;
    const teacherPeriodsMotesetaRaw = document.getElementById('teacherPeriodsMoteseta') && document.getElementById('teacherPeriodsMoteseta').textContent;

    let classNames=[], subjectNames=[], levelNames=[], semesterNames=[], periodNames=[], teacherClasses=[], teacherSubjects=[], teacherLevels=[], teacherSemesters=[], teacherPeriodsEbtedai=[], teacherPeriodsMoteseta=[];
    try{ classNames = classNamesRaw? JSON.parse(classNamesRaw): []; }catch(e){ classNames = []; }
    try{ subjectNames = subjectNamesRaw? JSON.parse(subjectNamesRaw): []; }catch(e){ subjectNames = []; }
    try{ levelNames = levelNamesRaw? JSON.parse(levelNamesRaw): []; }catch(e){ levelNames = []; }
    try{ semesterNames = semesterNamesRaw? JSON.parse(semesterNamesRaw): []; }catch(e){ semesterNames = []; }
    try{ periodNames = periodNamesRaw? JSON.parse(periodNamesRaw): []; }catch(e){ periodNames = []; }
    try{ teacherClasses = teacherClassesRaw? JSON.parse(teacherClassesRaw): []; }catch(e){ teacherClasses = []; }
    try{ teacherSubjects = teacherSubjectsRaw? JSON.parse(teacherSubjectsRaw): []; }catch(e){ teacherSubjects = []; }
    try{ teacherLevels = teacherLevelsRaw? JSON.parse(teacherLevelsRaw): []; }catch(e){ teacherLevels = []; }
    try{ teacherSemesters = teacherSemestersRaw? JSON.parse(teacherSemestersRaw): []; }catch(e){ teacherSemesters = []; }
    try{ teacherPeriodsEbtedai = teacherPeriodsEbtedaiRaw? JSON.parse(teacherPeriodsEbtedaiRaw): []; }catch(e){ teacherPeriodsEbtedai = []; }
    try{ teacherPeriodsMoteseta = teacherPeriodsMotesetaRaw? JSON.parse(teacherPeriodsMotesetaRaw): []; }catch(e){ teacherPeriodsMoteseta = []; }

    setupTagInput('class_search_input','selected_classes','classNames','classes', teacherClasses);
    setupTagInput('subject_search_input','selected_subjects','subjectNames','subjects', teacherSubjects);
    setupTagInput('level_search_input','selected_levels','levelNames','levels', teacherLevels);
    setupTagInput('semester_search_input','selected_semesters','semesterNames','semesters', teacherSemesters);
    setupTagInput('period_ebtedai_search_input','selected_periods_ebtedai','periodNames','periods_ebtedai', teacherPeriodsEbtedai);
    setupTagInput('period_moteseta_search_input','selected_periods_moteseta','periodNames','periods_moteseta', teacherPeriodsMoteseta);

  })();
</script>

<script>
  (function() {
    const form = document.getElementById('teacher-wizard-form');
    if (!form) return;

    const stepPanels = Array.from(form.querySelectorAll('.teacher-step-panel'));
    const stepIndicators = Array.from(form.querySelectorAll('.teacher-step-indicator'));
    const prevButton = document.getElementById('teacher-prev-step');
    const nextButton = document.getElementById('teacher-next-step');
    const submitButton = document.getElementById('teacher-submit-step');
    const stepCounter = document.getElementById('teacher-step-counter');
    const stepTitle = document.getElementById('teacher-step-title');
    const totalSteps = stepPanels.length;

    let currentStep = 1;

    function getPanel(step) {
      return stepPanels.find((panel) => Number(panel.dataset.teacherStep) === Number(step));
    }

    function setIndicatorStyles(activeStep) {
      stepIndicators.forEach((indicator) => {
        const isActive = Number(indicator.dataset.teacherStepIndicator) === Number(activeStep);
        if (isActive) {
          indicator.classList.remove('bg-white', 'text-gray-600');
          indicator.classList.add('bg-blue-600', 'text-white');
          indicator.setAttribute('aria-current', 'step');
        } else {
          indicator.classList.remove('bg-blue-600', 'text-white');
          indicator.classList.add('bg-white', 'text-gray-600');
          indicator.removeAttribute('aria-current');
        }
      });
    }

    function setStep(step) {
      const safeStep = Math.min(Math.max(Number(step), 1), totalSteps);
      currentStep = safeStep;

      stepPanels.forEach((panel) => {
        panel.classList.toggle('hidden', Number(panel.dataset.teacherStep) !== safeStep);
      });

      if (stepCounter) {
        stepCounter.textContent = `مرحله ${safeStep} از ${totalSteps}`;
      }

      const activePanel = getPanel(safeStep);
      if (stepTitle && activePanel) {
        stepTitle.textContent = activePanel.dataset.stepTitle || '';
      }

      if (prevButton) {
        prevButton.classList.toggle('hidden', safeStep === 1);
      }
      if (nextButton) {
        nextButton.classList.toggle('hidden', safeStep === totalSteps);
      }
      if (submitButton) {
        submitButton.classList.toggle('hidden', safeStep !== totalSteps);
      }

      setIndicatorStyles(safeStep);
    }

    function requireValue(selector, message, stepOverride) {
      const el = form.querySelector(selector);
      if (!el) return true;
      const value = (el.value || '').trim();
      if (!value) {
        setStep(stepOverride || currentStep);
        alert(message);
        if (el.focus) el.focus();
        return false;
      }
      return true;
    }

    function requireAnyHidden(containerSelector, message, stepOverride) {
      const container = form.querySelector(containerSelector);
      if (!container) return true;
      const hiddenInputs = container.querySelectorAll('input[type="hidden"]');
      if (!hiddenInputs.length) {
        setStep(stepOverride || currentStep);
        alert(message);
        return false;
      }
      return true;
    }

    function requireFile(selector, message, stepOverride) {
      const el = form.querySelector(selector);
      if (!el) return true;
      const hasFile = el.files && el.files.length > 0;
      const hasExisting = el.dataset && el.dataset.hasFile === '1';
      if (!hasFile && !hasExisting) {
        setStep(stepOverride || currentStep);
        alert(message);
        return false;
      }
      return true;
    }

    function validateStep(step) {
      const panel = getPanel(step);
      if (!panel) return true;

      if (step === 1) {
        if (!requireValue('#id_name', 'نام و تخلص استاد را وارد کنید.', step)) return false;
        if (!requireValue('#id_father_name', 'نام پدر را وارد کنید.', step)) return false;
        if (!requireValue('#id_gender', 'جنسیت را انتخاب کنید.', step)) return false;
        if (!requireValue('#id_id_number', 'نمبر تذکره را وارد کنید.', step)) return false;
        if (!requireValue('#id_birth_date', 'تاریخ تولد را وارد کنید.', step)) return false;
      }

      if (step === 2) {
        if (!requireValue('#id_permanent_address', 'ولایت اصلی را وارد کنید.', step)) return false;
        if (!requireValue('#id_district', 'ولسوالی را وارد کنید.', step)) return false;
        if (!requireValue('#id_village', 'قریه را وارد کنید.', step)) return false;
        if (!requireValue('#id_current_address', 'ولایت فعلی را وارد کنید.', step)) return false;
        if (!requireValue('#id_area', 'ناحیه را وارد کنید.', step)) return false;
      }

      if (step === 3) {
        if (!requireValue('#id_education_level', 'سویه تحصیلی را انتخاب کنید.', step)) return false;
        if (!requireFile('#id_education_document', 'اسناد تحصیلی را آپلود کنید.', step)) return false;
      }

      if (step === 4) {
        if (!requireAnyHidden('#selected_levels', 'حداقل یک سطح تدریس را انتخاب کنید.', step)) return false;
        if (!requireAnyHidden('#selected_classes', 'حداقل یک صنف را انتخاب کنید.', step)) return false;
        if (!requireAnyHidden('#selected_subjects', 'حداقل یک مضمون را انتخاب کنید.', step)) return false;

        const levelValues = Array.from(form.querySelectorAll('#selected_levels input[type="hidden"]')).map((el) => el.value);
        if (levelValues.includes('aali')) {
          if (!requireAnyHidden('#selected_semesters', 'برای دوره عالی، حداقل یک سمستر را انتخاب کنید.', step)) return false;
        }
        if (levelValues.includes('ebtedai')) {
          if (!requireAnyHidden('#selected_periods_ebtedai', 'برای دوره ابتداییه، حداقل یک دوره را انتخاب کنید.', step)) return false;
        }
        if (levelValues.includes('moteseta')) {
          if (!requireAnyHidden('#selected_periods_moteseta', 'برای دوره متوسطه، حداقل یک دوره را انتخاب کنید.', step)) return false;
        }
      }

      return true;
    }

    if (prevButton) {
      prevButton.addEventListener('click', function() {
        setStep(currentStep - 1);
      });
    }

    if (nextButton) {
      nextButton.addEventListener('click', function() {
        if (!validateStep(currentStep)) return;
        setStep(currentStep + 1);
      });
    }

    stepIndicators.forEach((indicator) => {
      indicator.addEventListener('click', function() {
        const targetStep = Number(indicator.dataset.teacherStepIndicator);
        if (!targetStep || targetStep === currentStep) return;

        if (targetStep > currentStep && !validateStep(currentStep)) {
          return;
        }

        setStep(targetStep);
      });
    });

    form.addEventListener('submit', function(event) {
      for (let step = 1; step <= totalSteps; step += 1) {
        if (!validateStep(step)) {
          event.preventDefault();
          return;
        }
      }
    });

    const firstError = form.querySelector('p.text-red-600');
    if (firstError) {
      const errorPanel = firstError.closest('.teacher-step-panel');
      if (errorPanel && errorPanel.dataset.teacherStep) {
        currentStep = Number(errorPanel.dataset.teacherStep);
      }
    }

    setStep(currentStep);
  })();
</script>
{% endblock %}

{% endblock %}
