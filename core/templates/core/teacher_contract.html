{% extends 'core/base.html' %}
{% load static form_tags %}

{% block content %}
  <div class="bg-white p-6 rounded-xl shadow-md">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-2xl font-bold">قرارداد استاد</h2>
        <p class="text-sm text-gray-500">مشخصات قرارداد را وارد کنید و فایل PDF را دریافت نمایید.</p>
      </div>
      <div class="hidden sm:flex items-center gap-3">
        <a href="{% url 'core:teacher_list' %}" class="text-sm text-blue-600 hover:underline">بازگشت به لیست</a>
        <a href="{% url 'core:teacher_edit' teacher.pk %}" class="text-sm text-blue-600 hover:underline">ویرایش استاد</a>
      </div>
    </div>

    <form method="post" enctype="multipart/form-data" class="contract-form grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
      {% csrf_token %}

      <div class="space-y-4">
        <div class="bg-gray-50/50 border border-gray-200 rounded-xl p-4">
          <h3 class="text-sm font-semibold text-gray-700 mb-3">مشخصات استاد</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
            <div><span class="text-gray-500">نام:</span> <span class="text-gray-900">{{ teacher.name }}</span></div>
            <div><span class="text-gray-500">نام پدر:</span> <span class="text-gray-900">{{ teacher.father_name|default:'—' }}</span></div>
            <div><span class="text-gray-500">تذکره:</span> <span class="text-gray-900">{{ teacher.id_number|default:'—' }}</span></div>
            <div><span class="text-gray-500">سویه تحصیلی:</span> <span class="text-gray-900">{{ teacher.get_education_level_display }}</span></div>
            <div><span class="text-gray-500">سطوح تدریس:</span> <span class="text-gray-900">{{ teacher_levels }}</span></div>
            <div><span class="text-gray-500">سمسترها:</span> <span class="text-gray-900">{{ teacher_semesters }}</span></div>
            <div><span class="text-gray-500">دوره‌ها:</span> <span class="text-gray-900">{{ teacher_periods }}</span></div>
            <div><span class="text-gray-500">مضامین:</span> <span class="text-gray-900">{{ teacher_subjects }}</span></div>
            <div><span class="text-gray-500">صنوف:</span> <span class="text-gray-900">{{ teacher_classes }}</span></div>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">شماره ثبت</label>
            <input type="text" class="border border-gray-300 rounded px-2 py-1 w-full bg-gray-100 text-gray-700" value="{{ contract.contract_number|default:'—' }}" readonly>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">تاریخ قرارداد</label>
            {{ form.contract_date }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">معاش ماهوار</label>
            {{ form.monthly_salary }}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">وظیفه/سمت</label>
            {{ form.position }}
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">فایل قرارداد امضاشده (پس از امضا و اسکن)</label>
          {{ form.signed_file }}
          {% if contract.signed_file %}
            <p class="text-xs text-gray-500 mt-2">
              فایل فعلی: <a href="{{ contract.signed_file.url }}" class="text-blue-600 hover:underline">دانلود قرارداد امضاشده</a>
            </p>
          {% endif %}
        </div>

        <div class="pt-2 flex flex-wrap items-center gap-3">
          <button type="submit" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md shadow">ذخیره قرارداد</button>
          <button type="button" id="download-pdf-btn" class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md shadow">دانلود PDF</button>
        </div>
      </div>

      <div>
        <div id="contract-preview" class="contract-paper p-8"
             data-teacher-name="{{ teacher.name|default:'' }}"
             data-father-name="{{ teacher.father_name|default:'' }}"
             data-village="{{ teacher.village|default:'' }}"
             data-district="{{ teacher.district|default:'' }}"
             data-area="{{ teacher.area|default:'' }}"
             data-permanent-province="{{ teacher.permanent_address|default:'' }}"
             data-current-province="{{ teacher.current_address|default:'' }}"
             data-id-number="{{ teacher.id_number|default:'' }}"
             data-education-level="{{ teacher.get_education_level_display|default:'' }}">
          <div class="contract-header">
            <div class="contract-logo-block">
              <div class="contract-logo">
                <img src="{% url 'core:emirate_logo' %}" alt="لوگوی امارت" onerror="this.style.display='none';" />
              </div>
              <div class="contract-logo-meta">
                تاریخ:
                <span id="header-date-day">—</span>
                /
                <span id="header-date-month">—</span>
                /
                <span id="header-date-year">—</span>
              </div>
            </div>
            <div class="contract-org">
              <div class="contract-org-line">وزارت معارف</div>
              <div class="contract-org-line">معینیت تعلیمات اسلامی</div>
              <div class="contract-org-line contract-org-title">دارالعلوم عالی الحاج سید منصور نادری</div>
              <div class="contract-org-line">مدیریت اداری</div>
              <div class="contract-org-line">قرارداد خط کارمندان/اساتید</div>
            </div>
            <div class="contract-logo-block">
              <div class="contract-logo">
                <img src="{% url 'core:logo' %}" alt="لوگوی دارالعلوم" onerror="this.style.display='none';" />
              </div>
              <div class="contract-logo-meta">
                شماره ثبت: ( <span id="preview-contract-number" class="contract-value">{{ contract.contract_number|default:'—' }}</span> )
              </div>
            </div>
          </div>
          <div class="contract-divider"></div>

          <div class="mt-6 text-sm leading-7">
            <p id="preview-terms" class="mt-1 whitespace-pre-wrap">{{ default_terms }}</p>
          </div>

          <div class="mt-10 grid grid-cols-1 sm:grid-cols-3 gap-8 text-center text-sm">
            <div class="contract-signature">
              <div class="contract-sign-line"></div>
              <div class="mt-2">نام و امضای کارمند/استاد</div>
              <div class="mt-1 text-xs text-gray-600">{{ teacher.name|default:'—' }}</div>
            </div>
            <div class="contract-signature">
              <div class="contract-sign-line"></div>
              <div class="mt-2">نام و امضای آمر دارالعلوم</div>
            </div>
            <div class="contract-signature">
              <div class="contract-sign-line"></div>
              <div class="mt-2">نام و امضای مدیر اداری دارالعلوم</div>
            </div>
          </div>
        </div>
        <p class="text-xs text-gray-500 mt-3">برای چاپ، از دکمه «دانلود PDF» استفاده کنید. اگر متن طولانی باشد، PDF چند صفحه می‌شود.</p>
      </div>
    </form>
  </div>

  <script type="text/plain" id="contract-template">{{ default_terms }}</script>

  <style>
    .contract-paper {
      background: #ffffff;
      color: #0f172a;
      direction: rtl;
      width: 100%;
      max-width: 794px;
      height: auto;
      min-height: 1123px;
      margin: 0 auto;
      position: relative;
    }
    .contract-paper .contract-value {
      color: #0f172a;
      font-weight: 700;
    }
    #preview-terms {
      white-space: pre-wrap;
      line-height: 1.9;
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    .contract-header {
      display: grid;
      grid-template-columns: 100px 1fr 100px;
      align-items: center;
      gap: 12px;
    }
    .contract-logo-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    .contract-logo {
      width: 96px;
      height: 96px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: #ffffff;
    }
    .contract-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 8px;
    }
    .contract-logo-meta {
      font-size: 12px;
      color: #334155;
      white-space: nowrap;
    }
    .contract-org {
      text-align: center;
      line-height: 1.5;
    }
    .contract-org-line {
      font-size: 16px;
      font-weight: 700;
      color: #0f172a;
    }
    .contract-org-title {
      font-size: inherit;
      font-weight: 700;
      margin-top: 0;
    }
    .contract-org-meta {
      margin-top: 6px;
      font-size: 12px;
      letter-spacing: 0.02em;
      color: #334155;
      white-space: nowrap;
    }
    .contract-divider {
      margin-top: 16px;
      border-top: 2px solid #0f172a;
    }
    .contract-signature {
      padding: 16px 12px;
      border-radius: 10px;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
    }
    .contract-sign-line {
      width: 80%;
      border-top: 1px solid #0f172a;
    }
    .contract-form input,
    .contract-form textarea,
    .contract-form select {
      color: #0f172a;
    }
    .contract-form input::placeholder,
    .contract-form textarea::placeholder {
      color: #94a3b8;
    }
    html.dark .contract-form input,
    html.dark .contract-form textarea,
    html.dark .contract-form select {
      color: #e2e8f0;
      background-color: #0f172a;
      border-color: #334155;
    }
    html.dark .contract-form input::placeholder,
    html.dark .contract-form textarea::placeholder {
      color: #94a3b8;
    }
    html.dark .contract-paper {
      background: #ffffff;
      color: #0f172a;
    }
  </style>

  <link rel="stylesheet" href="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.css">
  <script src="https://unpkg.com/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    (function(){
      const bindings = [
        { input: 'id_contract_date', output: 'preview-contract-date', fallback: '—', isDate: true },
        { input: 'id_monthly_salary', output: 'preview-salary', fallback: '—' },
        { input: 'id_position', output: 'preview-position', fallback: '—' }
      ];

      const afghanMonths = ['حمل','ثور','جوزا','سرطان','اسد','سنبله','میزان','عقرب','قوس','جدی','دلو','حوت'];

      function toPersianDigits(input) {
        const map = { '0': '۰','1': '۱','2': '۲','3': '۳','4': '۴','5': '۵','6': '۶','7': '۷','8': '۸','9': '۹' };
        return String(input).replace(/[0-9]/g, (d) => map[d] || d);
      }

      function toEnglishDigits(input) {
        const map = { '۰': '0','۱': '1','۲': '2','۳': '3','۴': '4','۵': '5','۶': '6','۷': '7','۸': '8','۹': '9' };
        return String(input).replace(/[۰-۹]/g, (d) => map[d] || d);
      }

      function pad2(n) {
        return String(n).padStart(2, '0');
      }

      function gregorianToJalali(gy, gm, gd) {
        const g_d_m = [0,31,59,90,120,151,181,212,243,273,304,334];
        const gy2 = (gm > 2) ? (gy + 1) : gy;
        let days = 355666 + (365 * gy) + Math.floor((gy2 + 3) / 4)
          - Math.floor((gy2 + 99) / 100) + Math.floor((gy2 + 399) / 400)
          + gd + g_d_m[gm - 1];
        let jy = -1595 + 33 * Math.floor(days / 12053);
        days %= 12053;
        jy += 4 * Math.floor(days / 1461);
        days %= 1461;
        if (days > 365) {
          jy += Math.floor((days - 1) / 365);
          days = (days - 1) % 365;
        }
        const jm = (days < 186) ? 1 + Math.floor(days / 31) : 7 + Math.floor((days - 186) / 30);
        const jd = 1 + (days < 186 ? (days % 31) : ((days - 186) % 30));
        return [jy, jm, jd];
      }

      function jalaliToGregorian(jy, jm, jd) {
        jy = parseInt(jy, 10);
        jm = parseInt(jm, 10);
        jd = parseInt(jd, 10);
        jy += 1595;
        let days = -355668 + (365 * jy) + Math.floor(jy / 33) * 8 + Math.floor(((jy % 33) + 3) / 4) + jd;
        if (jm < 7) {
          days += (jm - 1) * 31;
        } else {
          days += ((jm - 7) * 30) + 186;
        }
        let gy = 400 * Math.floor(days / 146097);
        days %= 146097;
        if (days > 36524) {
          gy += 100 * Math.floor(--days / 36524);
          days %= 36524;
          if (days >= 365) days++;
        }
        gy += 4 * Math.floor(days / 1461);
        days %= 1461;
        if (days > 365) {
          gy += Math.floor((days - 1) / 365);
          days = (days - 1) % 365;
        }
        let gd = days + 1;
        const sal_a = [0,31,((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) ? 29 : 28,31,30,31,30,31,31,30,31,30,31];
        let gm;
        for (gm = 1; gm <= 12 && gd > sal_a[gm]; gm++) {
          gd -= sal_a[gm];
        }
        return [gy, gm, gd];
      }

      function parseJalaliDate(value) {
        const raw = toEnglishDigits(value || '').trim();
        if (!raw) return null;
        const parts = raw.split(/[\/\-]/);
        if (parts.length !== 3) return null;
        const jy = parseInt(parts[0], 10);
        const jm = parseInt(parts[1], 10);
        const jd = parseInt(parts[2], 10);
        if (!jy || !jm || !jd) return null;
        return [jy, jm, jd];
      }

      function toAfghanDate(value) {
        if (!value) return '';
        const raw = toEnglishDigits(value).trim();
        if (!raw) return '';
        if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) {
          const [gy, gm, gd] = raw.split('-').map((n) => parseInt(n, 10));
          if (!gy || !gm || !gd) return value;
          const [jy, jm, jd] = gregorianToJalali(gy, gm, gd);
          return toPersianDigits(`${jd} ${afghanMonths[jm - 1]} ${jy}`);
        }
        const parsed = parseJalaliDate(raw);
        if (parsed) {
          const [jy, jm, jd] = parsed;
          return toPersianDigits(`${jd} ${afghanMonths[jm - 1]} ${jy}`);
        }
        return value;
      }

      function setHeaderJalaliDate() {
        const dayEl = document.getElementById('header-date-day');
        const monthEl = document.getElementById('header-date-month');
        const yearEl = document.getElementById('header-date-year');
        if (!dayEl || !monthEl || !yearEl) return;
        const now = new Date();
        const [jy, jm, jd] = gregorianToJalali(now.getFullYear(), now.getMonth() + 1, now.getDate());
        dayEl.textContent = toPersianDigits(pad2(jd));
        monthEl.textContent = toPersianDigits(pad2(jm));
        yearEl.textContent = toPersianDigits(jy);
      }

      function setPreview(outputId, value, fallback, isDate) {
        const el = document.getElementById(outputId);
        if (!el) return;
        let text = value && value.trim() ? value.trim() : '';
        if (isDate) {
          text = text ? toAfghanDate(text) : '';
        }
        el.textContent = text || fallback;
      }

      const contractPreview = document.getElementById('contract-preview');
      const termsPreview = document.getElementById('preview-terms');
      const templateEl = document.getElementById('contract-template');
      const defaultTemplate = templateEl ? templateEl.textContent : '';

      const tokenFallbacks = {
        contract_date: '     /     /          ',
        teacher_name: '                     ',
        father_name: '                 ',
        permanent_village: '              ',
        permanent_district: '                ',
        permanent_province: '                   ',
        current_area: '                ',
        current_province: '              ',
        id_number: '                                ',
        education_level: '             ',
        position: '                                 ',
        monthly_salary: '_________',
      };

      function hasText(value) {
        return value && String(value).replace(/\s/g, '') !== '';
      }

      function normalizeValue(value, fallback) {
        const str = value === undefined || value === null ? '' : String(value);
        return hasText(str) ? str : fallback;
      }


      function getInputValue(inputId, fallback, isDate) {
        const inputEl = document.getElementById(inputId);
        const raw = inputEl ? inputEl.value : '';
        let value = raw && raw.trim() ? raw.trim() : '';
        if (isDate) value = value ? toAfghanDate(value) : '';
        return normalizeValue(value, fallback);
      }

      function buildTokenMap() {
        const data = contractPreview ? contractPreview.dataset : {};

        return {
          contract_date: getInputValue('id_contract_date', tokenFallbacks.contract_date, true),
          teacher_name: normalizeValue(data.teacherName, tokenFallbacks.teacher_name),
          father_name: normalizeValue(data.fatherName, tokenFallbacks.father_name),
          permanent_village: normalizeValue(data.village, tokenFallbacks.permanent_village),
          permanent_district: normalizeValue(data.district, tokenFallbacks.permanent_district),
          permanent_province: normalizeValue(data.permanentProvince, tokenFallbacks.permanent_province),
          current_area: normalizeValue(data.area, tokenFallbacks.current_area),
          current_province: normalizeValue(data.currentProvince, tokenFallbacks.current_province),
          id_number: normalizeValue(data.idNumber, tokenFallbacks.id_number),
          education_level: normalizeValue(data.educationLevel, tokenFallbacks.education_level),
          position: getInputValue('id_position', tokenFallbacks.position, false),
          monthly_salary: getInputValue('id_monthly_salary', tokenFallbacks.monthly_salary, false),
        };
      }

      function renderTerms() {
        if (!termsPreview) return '';
        const templateText = defaultTemplate;
        if (!templateText) return '';
        const tokens = buildTokenMap();
        const rendered = templateText.replace(/\[\[(\w+)\]\]/g, (match, key) => {
          if (Object.prototype.hasOwnProperty.call(tokens, key)) return tokens[key];
          return match;
        });
        termsPreview.textContent = rendered;
        return rendered;
      }

      function updatePreview() {
        bindings.forEach(({input, output, fallback, isDate}) => {
          const inputEl = document.getElementById(input);
          const value = inputEl ? inputEl.value : '';
          setPreview(output, value, fallback, isDate);
        });
        renderTerms();
      }

      const dateInputIds = ['id_contract_date'];

      function normalizeInitialDates() {
        dateInputIds.forEach((id) => {
          const input = document.getElementById(id);
          if (!input || !input.value) return;
          const raw = toEnglishDigits(input.value).trim();
          if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) {
            const [gy, gm, gd] = raw.split('-').map((n) => parseInt(n, 10));
            if (!gy || !gm || !gd) return;
            const [jy, jm, jd] = gregorianToJalali(gy, gm, gd);
            input.value = toPersianDigits(`${jy}/${pad2(jm)}/${pad2(jd)}`);
          }
        });
      }

      bindings.forEach(({input}) => {
        const inputEl = document.getElementById(input);
        if (inputEl) {
          inputEl.addEventListener('input', updatePreview);
          inputEl.addEventListener('change', updatePreview);
        }
      });
      normalizeInitialDates();

      if (window.jalaliDatepicker) {
        jalaliDatepicker.startWatch({
          months: afghanMonths,
          persianDigits: true,
        });
      }

      setHeaderJalaliDate();
      updatePreview();

      const formEl = document.querySelector('.contract-form');
      if (formEl) {
        formEl.addEventListener('submit', function(){
          renderTerms();
          dateInputIds.forEach((id) => {
            const input = document.getElementById(id);
            if (!input || !input.value) return;
            const parsed = parseJalaliDate(input.value);
            if (!parsed) return;
            const [jy, jm, jd] = parsed;
            const [gy, gm, gd] = jalaliToGregorian(jy, jm, jd);
            input.value = `${gy}-${pad2(gm)}-${pad2(gd)}`;
          });
        });
      }

      const downloadBtn = document.getElementById('download-pdf-btn');
      if (downloadBtn) {
        downloadBtn.addEventListener('click', async function(){
          const preview = document.getElementById('contract-preview');
          if (!preview) return;
          try {
            const canvas = await html2canvas(preview, { scale: 2, useCORS: true });
            const { jsPDF } = window.jspdf || window;
            if (!jsPDF) {
              alert('کتابخانه PDF بارگذاری نشد.');
              return;
            }
            const pdf = new jsPDF('p', 'pt', 'a4');
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 24;
            const usableWidth = pageWidth - (margin * 2);
            const scale = usableWidth / canvas.width;
            const pageSlicePx = (pageHeight - (margin * 2)) / scale;
            let renderedHeight = 0;
            let pageIndex = 0;

            while (renderedHeight < canvas.height) {
              const sliceHeight = Math.min(pageSlicePx, canvas.height - renderedHeight);
              const pageCanvas = document.createElement('canvas');
              pageCanvas.width = canvas.width;
              pageCanvas.height = sliceHeight;
              const ctx = pageCanvas.getContext('2d');
              ctx.drawImage(
                canvas,
                0,
                renderedHeight,
                canvas.width,
                sliceHeight,
                0,
                0,
                canvas.width,
                sliceHeight
              );

              const imgData = pageCanvas.toDataURL('image/png');
              if (pageIndex > 0) pdf.addPage();
              const imgHeight = sliceHeight * scale;
              pdf.addImage(imgData, 'PNG', margin, margin, usableWidth, imgHeight);
              renderedHeight += sliceHeight;
              pageIndex += 1;
            }

            pdf.save('teacher-contract-{{ teacher.pk }}.pdf');
          } catch (err) {
            console.error(err);
            alert('خطا در ساخت PDF. لطفاً دوباره تلاش کنید.');
          }
        });
      }
    })();
  </script>
{% endblock %}
